from django.shortcuts import render
from django.http import *
from product.models import *
from customer.models import *
from order.models import *
from django.template.loader import *
# Create your views here.
def save_category(request):
    if request.method == 'GET':
        cid = request.GET['cid']
        pid = request.GET['pid']
        c = Select_category.objects.filter(product_id=pid,category_id=cid).exists()
        if c != True:
            Select_category(
                product_id=pid,
                category_id=cid
            ).save()
        else:
            Select_category.objects.get(product_id=pid,category_id=cid).delete()
            
            
    return JsonResponse({'status': 'status'}) 

def search_product(request):
    cm = ''
    if request.session.has_key('customer_mobile'):
        customer_mobile = request.session['customer_mobile']
        cm=Customer.objects.filter(mobile=customer_mobile).first()
    if request.method == 'GET':
        cid = request.GET['cid']
        p=[]
        c = Select_category.objects.filter(category_id=cid)
        if c:
            for c in c:
                pid = c.product_id
                if pid:
                    pr = Product.objects.filter(id=pid)
                    p.extend(pr)
    context={
        'p':p,
        'cm':cm
    }
    t = render_to_string('ajax/search_product.html', context)
    return JsonResponse({'t': t}) 


def add_to_cart(request):
    if request.method == 'GET':
        pid = request.GET['pid']
        qty = request.GET['qty']
        status = 36
        ng = '0'
        if request.session.has_key('customer_mobile'):
            customer_mobile = request.session['customer_mobile']
            check=Customer.objects.filter(mobile=customer_mobile).count()
            if check == 1:
                c = Customer.objects.get(mobile=customer_mobile)
                cart_check = Cart.objects.filter(customer_id=c.id,product_id=pid).count()
                if cart_check == 1:
                    cart = Cart.objects.get(customer_id=c.id,product_id=pid)
                    cart.qty = qty
                    cart.save()
                    ng=len(Cart.objects.filter(customer_id=c.id))
                elif cart_check == 0:
                    Cart(
                        customer_id = c.id,
                        product_id = request.GET['pid'],
                        qty = request.GET['qty'],
                        ).save()
                    ng=len(Cart.objects.filter(customer_id=c.id))
            elif check == 0:   
                del request.session['customer_mobile']
        else:
            status=0
    return JsonResponse({'status': status,'ng':ng}) 

 
def check_customer_mobile(request):
    if request.method == 'GET':
        mo = request.GET['mo']
        pid = request.GET['pid']
        qty = request.GET['qty']
        ng=[]
        check=Customer.objects.filter(mobile=mo).count()
        if check == 1:
            request.session['customer_mobile'] = mo
            customer_mobile = request.session['customer_mobile']
            c = Customer.objects.get(mobile=customer_mobile)
            cart_check = Cart.objects.filter(customer_id=c.id,product_id=pid).count()
            if cart_check == 1:
                cart = Cart.objects.get(customer_id=c.id,product_id=pid)
                cart.qty = qty
                cart.save()
                nk=len(Cart.objects.filter(customer_id=c.id))
                ng.append(nk)
            elif cart_check == 0:
                Cart(
                    customer_id = c.id,
                    product_id = request.GET['pid'],
                    qty = request.GET['qty'],
                    ).save()
                nk=len(Cart.objects.filter(customer_id=c.id))
                ng.append(nk)
        elif check == 0:
            Customer(
                mobile = mo
                ).save()
            cu = Customer.objects.get(mobile=mo)
            Cart(
                customer_id = cu.id,
                product_id = request.GET['pid'],
                qty = request.GET['qty'],
                ).save()
            ng=len(Cart.objects.filter(customer_id=cu.id))

            request.session['customer_mobile'] = mo
    return JsonResponse({'ng': ng}) 


def state(request):
    if request.method == 'GET':
        s = request.GET['s']
        cid = request.GET['cid']
        c = Customer.objects.get(id=cid)
        c.state = s
        c.save()
    return JsonResponse({'status':1}) 


def in_stock(request): 
    if request.method == 'GET':
        id = request.GET['id']
        if id:
            od = Order_detail.objects.get(id=id)
            if od.stock_status == 1:
                od.stock_status = 0
                od.save()
            else:
                od.stock_status = 1
                od.save()
    return JsonResponse({'status':1}) 

def cart_qty(request): 
    if request.method == 'GET':
        status = '0'
        qty = request.GET['qty']
        pid = request.GET['pid']
        cid = request.GET['cid']
        if qty:
            c = Cart.objects.get(product_id=pid,customer_id=cid)
            if c.qty != int(qty):
                c.qty = qty
                c.save()
                status = '1'

    return JsonResponse({'status':status}) 







































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































